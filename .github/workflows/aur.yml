name: Publish to AUR

on:
  release:
    types: [published]

jobs:
  aur-publish:
    name: Publish to AUR
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: |
          # Remove 'v' prefix from tag name (e.g., v1.0.0 -> 1.0.0)
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Version: ${VERSION}"

      - name: Download source tarball and calculate SHA256
        id: sha256
        run: |
          VERSION=${{ steps.version.outputs.version }}
          TARBALL_URL="https://github.com/freehuntx/x11-mouse-funnel/archive/v${VERSION}.tar.gz"
          echo "Downloading: ${TARBALL_URL}"
          curl -L -o source.tar.gz "${TARBALL_URL}"
          SHA256=$(sha256sum source.tar.gz | awk '{print $1}')
          echo "sha256=${SHA256}" >> $GITHUB_OUTPUT
          echo "SHA256: ${SHA256}"

      - name: Generate PKGBUILD
        run: |
          VERSION=${{ steps.version.outputs.version }}
          SHA256=${{ steps.sha256.outputs.sha256 }}
          sed -e "s/{{VERSION}}/${VERSION}/g" \
              -e "s/{{SHA256}}/${SHA256}/g" \
              PKGBUILD.template > PKGBUILD
          cat PKGBUILD

      - name: Generate .SRCINFO
        run: |
          # Use Docker container with Arch Linux to generate .SRCINFO
          docker run --rm -v "$PWD:/pkg" archlinux:latest bash -c "
            cd /pkg &&
            pacman -Sy --noconfirm pacman-contrib &&
            makepkg --printsrcinfo > .SRCINFO
          "
          cat .SRCINFO

      - name: Setup SSH for AUR
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AUR_SSH_KEY }}" > ~/.ssh/aur
          chmod 600 ~/.ssh/aur
          ssh-keyscan -H aur.archlinux.org >> ~/.ssh/known_hosts
          cat > ~/.ssh/config <<EOF
          Host aur.archlinux.org
            IdentityFile ~/.ssh/aur
            User aur
          EOF

      - name: Clone AUR repository
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git clone ssh://aur@aur.archlinux.org/x11-mouse-funnel.git \
            aur-repo || \
            git clone ssh://aur@aur.archlinux.org/x11-mouse-funnel.git \
            aur-repo

      - name: Update AUR repository
        run: |
          cp PKGBUILD aur-repo/
          cp .SRCINFO aur-repo/
          cd aur-repo
          git add PKGBUILD .SRCINFO
          VERSION="${{ steps.version.outputs.version }}"
          git commit -m "Update to version ${VERSION}" \
            || echo "No changes to commit"
          git push origin master
